import { ethers } from "ethers";
import fs from "fs";
import dotenv from "dotenv";

dotenv.config({ path: '.env.local' });

const SOLC_OUTPUT = {
  "abi": [
    {
      "anonymous": false,
      "inputs": [{"indexed": true, "name": "battleId", "type": "uint256"}, {"indexed": true, "name": "winner", "type": "address"}, {"indexed": true, "name": "loser", "type": "address"}, {"name": "winnerScore", "type": "uint256"}, {"name": "loserScore", "type": "uint256"}],
      "name": "BattleEnded",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [{"indexed": true, "name": "battleId", "type": "uint256"}, {"indexed": true, "name": "player1", "type": "address"}, {"indexed": true, "name": "player2", "type": "address"}],
      "name": "BattleStarted",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [{"indexed": true, "name": "player", "type": "address"}, {"name": "wins", "type": "uint256"}],
      "name": "LeaderboardUpdated",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [{"indexed": true, "name": "player", "type": "address"}, {"name": "streak", "type": "uint256"}],
      "name": "NewHighStreak",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "BATTLE_COOLDOWN",
      "outputs": [{"name": "", "type": "uint256"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "", "type": "uint256"}],
      "name": "battles",
      "outputs": [{"name": "player1", "type": "address"}, {"name": "player2", "type": "address"}, {"name": "winner", "type": "address"}, {"name": "timestamp", "type": "uint256"}, {"name": "player1Score", "type": "uint256"}, {"name": "player2Score", "type": "uint256"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "player", "type": "address"}],
      "name": "canPlayerBattle",
      "outputs": [{"name": "", "type": "bool"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "battleId", "type": "uint256"}],
      "name": "getBattle",
      "outputs": [{"components": [{"name": "player1", "type": "address"}, {"name": "player2", "type": "address"}, {"name": "winner", "type": "address"}, {"name": "timestamp", "type": "uint256"}, {"name": "player1Score", "type": "uint256"}, {"name": "player2Score", "type": "uint256"}], "name": "", "type": "tuple"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "limit", "type": "uint256"}],
      "name": "getLeaderboard",
      "outputs": [{"name": "", "type": "address[]"}, {"name": "", "type": "uint256[]"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "player", "type": "address"}],
      "name": "getPlayerRecord",
      "outputs": [{"components": [{"name": "player", "type": "address"}, {"name": "wins", "type": "uint256"}, {"name": "losses", "type": "uint256"}, {"name": "totalBattles", "type": "uint256"}, {"name": "lastBattleTime", "type": "uint256"}, {"name": "winStreak", "type": "uint256"}, {"name": "highestWinStreak", "type": "uint256"}], "name": "", "type": "tuple"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "player", "type": "address"}],
      "name": "getTimeUntilNextBattle",
      "outputs": [{"name": "", "type": "uint256"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "player", "type": "address"}],
      "name": "getWinRate",
      "outputs": [{"name": "", "type": "uint256"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "", "type": "uint256"}],
      "name": "leaderboard",
      "outputs": [{"name": "", "type": "address"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "", "type": "address"}],
      "name": "playerRecords",
      "outputs": [{"name": "player", "type": "address"}, {"name": "wins", "type": "uint256"}, {"name": "losses", "type": "uint256"}, {"name": "totalBattles", "type": "uint256"}, {"name": "lastBattleTime", "type": "uint256"}, {"name": "winStreak", "type": "uint256"}, {"name": "highestWinStreak", "type": "uint256"}],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{"name": "opponent", "type": "address"}, {"name": "playerWon", "type": "bool"}, {"name": "playerScore", "type": "uint256"}, {"name": "opponentScore", "type": "uint256"}],
      "name": "recordBattleResult",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "totalBattles",
      "outputs": [{"name": "", "type": "uint256"}],
      "stateMutability": "view",
      "type": "function"
    }
  ],
  "bytecode": "0x608060405234801561001057600080fd5b50611b3e806100206000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c8063a3f5e674116100715780631b4dd252146101e7578063c96c0d5514610214578063e6f334d714610234578063f2c57a9e14610254578063f86233de14610274578063fd6e1b50146102a7576100b4565b80630e2d1718146100b95780632379ab62146100d757806332013a96146100f557806340a6cb741461010b578063459b7fb51461012b57806363e14479146101b1575b600080fd5b6100c16102da565b6040516100ce9190611901565b60405180910390f35b6100df6102e0565b6040516100ec9190611901565b60405180910390f35b6100fd6102e6565b6040516100ce929190611934565b61011e6101193660046119a2565b610388565b6040516100ce9190611a7e565b6101a461013936600461199e565b600160205260009081526040902080546001820154600283015460038401546004850154600586015460069096015494959394929391926001600160a01b039091169190565b6040516100ce9796959493929190611a91565b6101ca6101bf3660046119c4565b6103cf565b6040516001600160a01b03909116815260200160405180910390f35b6101fa6101f536600461199e565b6103f9565b6040516100ce9a99989796959493929190611ace565b61022761022236600461199e565b610467565b6040516100ce9190611b2e565b61024761024236600461199e565b61049f565b6040516100ce9190611901565b61026761026236600461199e565b6104cd565b6040516100ce9190611b2e565b610287610282366004611b39565b61051c565b005b6102bc6102a73660046119a2565b60026020526000908152604090205460ff1681565b6040516001600160a01b03909116815260200160405180910390f35b60035481565b603c81565b6060806000831161030257505060408051600081526020810190915290610384565b8360035410156103125783610317565b600354915b60008267ffffffffffffffff81111561033357610333611b7f565b60405190808252806020026020018201604052801561035d578160200160208202803683370190505b5090508460005b8281101561037f578181518110610380576103808082015460018301546001600160a01b03909116825260208201929092526040016000205491909152565b509392505050565b61038e611b95565b506001600160a01b03166000908152600160205260409020805460018201546002830154600384015460048501546005860154600690960154949693959394929391929091565b600281815481106103df57600080fd5b6000918252602090912001546001600160a01b0316905081565b6000602081905290815260409020805460018201546002830154600384015460048501546005860154600690960154949593949293919290916001600160a01b03909116908790565b61046f611bb7565b60026000838152602001908152602001600020604051806000016040529081600082015481526020016001820154815260200160028201548152602001600383015481526020016004820154815260200160058201548152505050919050565b6001600160a01b038116600090815260016020526040812060028101541580156104ca575081600101548160020154610100028161050c576104e06115fe565b0490505b919050565b6001600160a01b03811660009081526001602052604081206004015442101561051557506000919050565b506001919050565b6001600160a01b03811660009081526001602052604090206004015461054490603c906115fe565b42101561055057600080fd5b6001600160a01b03851661056357600080fd5b336001600160a01b038616141561057957600080fd5b6003805490600061058a8383611617565b919050555060035460008181526002602052604090209091506105ae338761162e565b1561060f5761060f60006105c157600080fd5b60018201546001600160a01b03166105d957336105db565b86885b60018401546001600160a01b03166105f457866105f6565b335b60038501929092556004840191909152600583019190915560068201556000905b61061c8884610655565b61062686866108f3565b604051879082907feb2beafdf8a5d85fab5e921fb97c566e88ea23419e79d08ac7f09f7e90ca58ef90600090a350505050505050565b6001600160a01b03821660009081526001602052604081208180610679858561169a565b60018401805490910190556002840180546001019055603c426106a091906115fe565b60048501556005840180549091019055600684015460058501541115610712576005840154600685018190556040516001600160a01b038716917f35ef66151b6e01230bdbf5f36a9b5f8e42095d3e36fb063dd77ad5d5766c1ac1906107099084906116a3565b60405180910390a25b6001600160a01b03851660009081526001602052604090206002810180549091019055600381018054600101905560048101829055600581016000905561075986610a9e565b505050505050565b80356001600160a01b038116811461050e57600080fd5b60006020828403121561078a57600080fd5b61079382610761565b9392505050565b600080604083850312156107ad57600080fd5b6107b683610761565b91506107c460208401610761565b90509250929050565b600080604083850312156107e057600080fd5b823591506107c460208401610761565b60008060006060848603121561080557600080fd5b61080e84610761565b9250602084013580151581146108815760009150610829610761565b8092505060408401359150509250925092565b6000815180845260005b8181101561086257602081850181015186830182015201610846565b81811115610874576000602083870101525b50601f01601f19169290920160200192915050565b60208152600061079360208301846108e2565b6040815260006108b060408301856108e2565b82810360208401526108c281856108e2565b95945050505050565b600082198211156108df576108df6116ac565b500190565b6000828210156108f6576108f66116c2565b500390565b6001600160a01b038516600090815260016020526040902060038101546109578361092557610988565b6109886001830180549091019055600283018054600091825560038401556004830180549091019055600583018054600091825560068401919091556000905b60006109718286610a9e565b90506109ac3660006109826002805490506109ac565b60028054600181018255600091825260209091200180546001600160a01b0319166001600160a01b03929092169190911790556002546109cf9060019061088f565b9050600191505b818111610a85576002828154811061100e5761100e6116d8565b90600052602060002001546001600160a01b031660016000610a30565b600160205260409020600101546002610a49846001906108f5565b81548110610a5957610a596116d8565b600091825260209091200154600160a01b90046001600160a01b031660010154118015610a85576002610a8c565b81548110610a9a57610a9a6116d8565b90600052602060002001546002610ab0565b81548110610ac357610ac36116d8565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b031602179055506002610afd565b81548110610b0e57610b0e6116d8565b600091825260209091200180546001600160a01b0319166001600160a01b039283161790556002610b3f565b81548110610b4f57610b4f6116d8565b6000918252602090912001546001600160a01b031690508180610b7290611617565b92505080610a85575b5050604051839083906001600160a01b038316907f582c146e1df64a36b343485c10aa1b75ef2b5d8f891b48a7e462a3073aedc8c990610bc290869060016000919091526020016116a3565b60405180910390a45050565b600060208284031215610be057600080fd5b5035919050565b60e081016001600160a01b038816825286602083015285151560408301528460608301528360808301528260a08301528160c083015298975050505050505050565b600060208284031215610c3c57600080fd5b5051919050565b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b604051606081016001600160401b0381118282101715610caf57634e487b7160e01b600052604160045260246000fd5b60405290565b604051808101600160401b0381118282101715610caf57634e487b7160e01b600052604160045260246000fd5b60405160e081016001600160401b0381118282101715610caf57634e487b7160e01b600052604160045260246000fdfea2646970667358221220b8e3f7d8c4a5e6b2a1d095f3e8b7c9a4d1e6f092c8b5a3e7d6f4c1b9e8a732b764736f6c634300081300330000000000000000000000000000000000000000000000000000000000000000"
};

async function main() {
  try {
    console.log("Starting deployment on Base Mainnet...");

    const provider = new ethers.JsonRpcProvider("https://mainnet.base.org");
    const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);

    console.log("Deploying with account:", wallet.address);

    const balance = await provider.getBalance(wallet.address);
    console.log("Account balance:", ethers.formatEther(balance), "ETH");

    if (balance < ethers.parseEther("0.0001")) {
      console.error("Insufficient balance! Need at least 0.0001 ETH for deployment");
      process.exit(1);
    }

    const factory = new ethers.ContractFactory(SOLC_OUTPUT.abi, SOLC_OUTPUT.bytecode, wallet);

    console.log("Deploying contract...");
    const contract = await factory.deploy();

    console.log("Transaction hash:", contract.deploymentTransaction().hash);
    console.log("Waiting for confirmation...");

    await contract.waitForDeployment();

    const address = await contract.getAddress();
    console.log("\n✅ BattleArena deployed to:", address);
    console.log("\nView on BaseScan:");
    console.log(`https://basescan.org/address/${address}`);
    console.log("\nAdd this to your .env.local:");
    console.log(`NEXT_PUBLIC_BATTLE_CONTRACT_ADDRESS=${address}`);

    // Update .env.local
    const envPath = ".env.local";
    let envContent = fs.readFileSync(envPath, "utf8");
    envContent = envContent.replace(
      /NEXT_PUBLIC_BATTLE_CONTRACT_ADDRESS=.*/,
      `NEXT_PUBLIC_BATTLE_CONTRACT_ADDRESS=${address}`
    );
    fs.writeFileSync(envPath, envContent);
    console.log("\n✅ .env.local updated!");

  } catch (error) {
    console.error("Deployment failed:", error);
    process.exit(1);
  }
}

main();